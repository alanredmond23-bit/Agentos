{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agentos.dev/schemas/eval_case.schema.json",
  "title": "AgentOS Eval Case",
  "description": "Schema for AgentOS evaluation test case definitions",
  "type": "object",
  "required": ["id", "name", "type", "input"],
  "additionalProperties": false,
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_-]*$",
      "description": "Unique identifier for this eval case"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200,
      "description": "Human-readable name for the eval case"
    },
    "description": {
      "type": "string",
      "maxLength": 2000,
      "description": "Detailed description of what this eval tests"
    },
    "type": {
      "type": "string",
      "enum": ["golden", "adversarial", "regression", "comparison", "performance", "safety"],
      "description": "Category of evaluation test"
    },
    "pack": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_-]*$",
      "description": "Pack this eval is associated with"
    },
    "agent": {
      "type": "string",
      "description": "Specific agent configuration to test"
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Tags for filtering and categorization"
    },
    "priority": {
      "type": "string",
      "enum": ["critical", "high", "medium", "low"],
      "default": "medium",
      "description": "Priority level for CI ordering"
    },
    "timeout_seconds": {
      "type": "integer",
      "minimum": 1,
      "maximum": 3600,
      "default": 60,
      "description": "Maximum time allowed for eval execution"
    },
    "retries": {
      "type": "integer",
      "minimum": 0,
      "maximum": 5,
      "default": 0,
      "description": "Number of retry attempts on failure"
    },
    "input": {
      "type": "object",
      "required": ["prompt"],
      "properties": {
        "prompt": {
          "type": "string",
          "minLength": 1,
          "description": "The input prompt to send to the agent"
        },
        "context": {
          "type": "object",
          "description": "Additional context variables",
          "additionalProperties": true
        },
        "files": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "content"],
            "properties": {
              "path": { "type": "string" },
              "content": { "type": "string" }
            }
          },
          "description": "Mock files to provide to the agent"
        },
        "environment": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Environment variables for the test"
        },
        "previous_messages": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["role", "content"],
            "properties": {
              "role": { "type": "string", "enum": ["user", "assistant", "system"] },
              "content": { "type": "string" }
            }
          },
          "description": "Conversation history for multi-turn tests"
        }
      }
    },
    "expected": {
      "type": "object",
      "properties": {
        "output": {
          "type": "object",
          "properties": {
            "contains": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Strings that must appear in output"
            },
            "not_contains": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Strings that must NOT appear in output"
            },
            "matches_regex": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Regex patterns that must match"
            },
            "exact": {
              "type": "string",
              "description": "Exact expected output (strict matching)"
            },
            "semantic_similarity": {
              "type": "object",
              "properties": {
                "reference": { "type": "string" },
                "threshold": { "type": "number", "minimum": 0, "maximum": 1 }
              },
              "description": "Semantic similarity comparison"
            }
          }
        },
        "tool_calls": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name"],
            "properties": {
              "name": { "type": "string" },
              "arguments": { "type": "object" },
              "must_call": { "type": "boolean", "default": true },
              "order": { "type": "integer", "minimum": 1 }
            }
          },
          "description": "Expected tool/function calls"
        },
        "behavior": {
          "type": "object",
          "properties": {
            "should_refuse": { "type": "boolean", "default": false },
            "should_ask_clarification": { "type": "boolean", "default": false },
            "should_escalate": { "type": "boolean", "default": false },
            "max_turns": { "type": "integer", "minimum": 1 }
          },
          "description": "Expected behavioral outcomes"
        },
        "safety": {
          "type": "object",
          "properties": {
            "no_pii_leak": { "type": "boolean", "default": true },
            "no_harmful_content": { "type": "boolean", "default": true },
            "respects_boundaries": { "type": "boolean", "default": true },
            "follows_policies": { "type": "array", "items": { "type": "string" } }
          },
          "description": "Safety requirements"
        },
        "performance": {
          "type": "object",
          "properties": {
            "max_latency_ms": { "type": "integer", "minimum": 1 },
            "max_tokens": { "type": "integer", "minimum": 1 },
            "max_cost_usd": { "type": "number", "minimum": 0 }
          },
          "description": "Performance thresholds"
        }
      }
    },
    "grading": {
      "type": "object",
      "properties": {
        "method": {
          "type": "string",
          "enum": ["exact", "contains", "regex", "semantic", "llm_judge", "human", "custom"],
          "default": "contains",
          "description": "How to grade the response"
        },
        "llm_judge": {
          "type": "object",
          "properties": {
            "model": { "type": "string" },
            "prompt_template": { "type": "string" },
            "pass_threshold": { "type": "number", "minimum": 0, "maximum": 1 }
          },
          "description": "LLM-as-judge configuration"
        },
        "custom_grader": {
          "type": "string",
          "description": "Path to custom grading script"
        },
        "partial_credit": {
          "type": "boolean",
          "default": false,
          "description": "Allow partial scores"
        },
        "weights": {
          "type": "object",
          "properties": {
            "output_accuracy": { "type": "number", "minimum": 0, "maximum": 1 },
            "tool_usage": { "type": "number", "minimum": 0, "maximum": 1 },
            "safety": { "type": "number", "minimum": 0, "maximum": 1 },
            "performance": { "type": "number", "minimum": 0, "maximum": 1 }
          },
          "description": "Weights for composite scoring"
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "author": { "type": "string" },
        "created_at": { "type": "string", "format": "date-time" },
        "updated_at": { "type": "string", "format": "date-time" },
        "version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
        "source": { "type": "string", "description": "Where this test case came from" },
        "related_issues": { "type": "array", "items": { "type": "string" } },
        "notes": { "type": "string" }
      }
    },
    "skip": {
      "type": "boolean",
      "default": false,
      "description": "Skip this test in CI"
    },
    "skip_reason": {
      "type": "string",
      "description": "Reason for skipping"
    },
    "dependencies": {
      "type": "array",
      "items": { "type": "string" },
      "description": "IDs of eval cases that must pass first"
    }
  }
}
