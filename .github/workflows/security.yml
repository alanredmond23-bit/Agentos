name: Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          chmod +x gitleaks

      - name: Run gitleaks
        run: |
          ./gitleaks detect --source . --verbose --no-git \
            --exit-code 1 \
            --report-format json \
            --report-path gitleaks-report.json || true

      - name: Check for secrets
        run: |
          if [[ -f gitleaks-report.json ]]; then
            LEAKS=$(cat gitleaks-report.json | jq 'length')
            if [[ "$LEAKS" -gt 0 ]]; then
              echo "Found $LEAKS potential secret(s)!"
              cat gitleaks-report.json | jq '.[].Description'
              exit 1
            fi
          fi
          echo "No secrets detected"

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate --json > npm-audit.json || true

          # Check for high/critical vulnerabilities
          HIGH=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')

          echo "High vulnerabilities: $HIGH"
          echo "Critical vulnerabilities: $CRITICAL"

          if [[ "$CRITICAL" -gt 0 ]]; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit
          path: npm-audit.json
          retention-days: 30

  yaml-security:
    name: YAML Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for dangerous YAML patterns
        run: |
          echo "Checking for dangerous YAML patterns..."

          # Check for potential command injection in YAML files
          DANGEROUS_PATTERNS=(
            '!!python'
            '!!ruby'
            '!!bash'
            '!!exec'
            '\$\(.*\)'
            '\`.*\`'
          )

          FOUND=0
          for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -rE "$pattern" agents/ evals/ 2>/dev/null; then
              echo "Found dangerous pattern: $pattern"
              FOUND=1
            fi
          done

          if [[ "$FOUND" -eq 1 ]]; then
            echo "Dangerous patterns found in YAML files!"
            exit 1
          fi

          echo "No dangerous patterns found"

  policy-validation:
    name: Policy Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check agent authority levels
        run: |
          echo "Checking for overly permissive authority configurations..."

          # Look for agents with autonomous execution and high financial limits
          ISSUES=0

          # This would be enhanced with a proper script
          for file in $(find agents -name "*.yaml" -o -name "*.yml" 2>/dev/null); do
            if grep -q "execution_model.*autonomous" "$file" 2>/dev/null; then
              if ! grep -q "financial_limits" "$file" 2>/dev/null; then
                echo "WARNING: $file has autonomous mode without financial_limits"
                ISSUES=$((ISSUES + 1))
              fi
            fi
          done

          if [[ "$ISSUES" -gt 0 ]]; then
            echo "Found $ISSUES policy concern(s)"
            # Warning only, don't fail
          fi

          echo "Policy validation complete"

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-audit, yaml-security, policy-validation]
    if: always()
    steps:
      - name: Check security results
        run: |
          if [[ "${{ needs.secret-scan.result }}" != "success" ]] ||
             [[ "${{ needs.dependency-audit.result }}" != "success" ]] ||
             [[ "${{ needs.yaml-security.result }}" != "success" ]]; then
            echo "Security checks failed!"
            exit 1
          fi
          echo "All security checks passed!"
